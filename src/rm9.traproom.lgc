[ ********************************************************************[[ rm9.traproom[[ box sitting 5,53[[ ********************************************************************[ **************************************[ LOCAL DEFINES[ **************************************#define Stairs o1#define Step v220#define Moving f220#define StairDir v221#define StairX v238#define StairY v237#define SqueakDelay v222#define StairDistance v223#define Lever o2#define fTrapMove f221#define Trap o3#define bsDoor o4#define fBsDoor f224#define Dripper o5#define fDrip f225#define vDripWait v224#define fClimbing f226#define fInBox f227#define fBelowTrap f228#define Spider o16#define fSpider f222#define fSpiderDone f223#define SpiderDir v234#define SpiderX v236#define SpiderY v235[ **************************************[ FIRST CYCLE ONLY[ **************************************if(newRoom)    {    [ load, draw and discard the picture for the current room    load.pic(currentRoom);    draw.pic(currentRoom);    discard.pic(currentRoom);        [ the horizon defines the upper limit of ego's movement    set.horizon(20);    load.sound(3);    load.sound(1);    load.sound(2);    SqueakDelay=1;        [ add additional room initialization here        animate.obj(Stairs);    load.view(102);    set.view(Stairs,102);    set.loop(Stairs,0);    fix.loop(Stairs);    stop.cycling(Stairs);    if ((Is1881 || PromptStairs)) { [always if we are in 1881, and if PromptStairs=1 ie under trapdoor     position(Stairs,69,147); [under trap     }    if (!PromptStairs) {     position(Stairs,5,147); [under box     }    Step=3;    step.time(Stairs,Step);        animate.obj(Lever);    set.view(Lever,102);    set.loop(Lever,2);    stop.cycling(Lever);           animate.obj(Trap);    set.view(Trap,102);    set.loop(Trap,1);    if(!isset(TrapDoor)) { [Door is shut     set.cel(Trap,0); [shut cel     set.cel(Lever,0); [up cel     }    else {     set.cel(Trap,3); [open cel     set.cel(Lever,1); [down cel     }    position(Lever,137,132);    position(Trap,67,45);        if (Is1881) {     animate.obj(Dripper);     set.view(Dripper,102);     set.loop(Dripper,3);     set.cel(Dripper,0);     set(fDrip);     vDripWait=17;     position(Dripper,138,144);     set.priority(Dripper,4);     draw(Dripper);     }        load.view(101);        animate.obj(bsDoor);    set.view(bsDoor,101);    set.loop(bsDoor,1);      position(bsDoor,129,146);    observe.objs(bsDoor);        [ load ego view, animate and draw ego    [ this is sometimes handled in logic 0    [ instead of in each individual logic        if (previousRoom == 4) { [pit     position (ego,2,156);     set.cel(bsDoor,0);     set(fBsDoor);     stop.cycling(bsDoor);     }         if ((previousRoom == 13 || [Left stage         previousRoom == 59)) { [Right stage     position (ego,118,146);     egoDir = 0;     set.cel(bsDoor,0);     set(fBsDoor);     stop.cycling(bsDoor);     }         if (previousRoom == 10) { [lower backstage     position (ego,146,143);     set.cel(bsDoor,4);     sound(2,soundDone);          reverse.loop(bsDoor,fBsDoor);         }        stop.cycling(Trap);    reset(Moving);    reset(fTrapMove);    reset(fSpider);    reset(fSpiderDone);    reset(fBelowTrap);    reset(fClimbing);    reset(fInBox);    draw(bsDoor);    draw(Stairs);    draw(Lever);    draw(Trap);      observe.objs(ego);    observe.blocks(ego);    draw(ego);                [ display the picture on screen    show.pic();    }[ **************************************[ EVERY CYCLE[ **************************************if (egoHitSpecial) { new.room(10); [ ##LE001## lower backstage} if(fTrapMove) { stop.cycling(Trap);}if(fBsDoor) { stop.cycling(bsDoor);}[Dripperif (Is1881) {  if (vDripWait==0) {  end.of.loop(Dripper,fDrip);  random(35,50,rndNum);  vDripWait=rndNum;  set.cel(Dripper,0);  force.update(Dripper);  }  }if (fClimbing) { [gone upstairs if (!PromptStairs) { [gone up to prompt box  erase(Stairs);  set.loop(Stairs,0);  stop.cycling(Stairs);  draw(Stairs);  set.view(ego,102);  set.loop(ego,4);  fix.loop(ego);  position(ego,5,55);  draw(ego);  print("You settle into the prompt box seat.");  display(24,3,"Type \"Use prompt\" to look through."); [34 chars  set(fInBox);  reset(fClimbing);  } else { [gone to trap door  erase(Stairs);  set.loop(Stairs,0);  stop.cycling(Stairs);  draw(Stairs);  position(ego,72,66);  egoDir=0;  draw(ego);  print("You feel unsteady up here.");  set(fBelowTrap);  player.control();  reset(fClimbing);  }}    [ **************************************[ PROCESS PLAYER INPUT[ **************************************if (edgeEgoHit == left_edge) { new.room(4); [ ##LE002##}if ((said("use", "trap") ||     said("climb",  "trap"))) {  if (fBelowTrap) {  print("You reach up and haul yourself onto the stage above.");  new.room(13); [ ##LE003##  } else {  print("Not from here.");   }}if ((said("get", "down") ||     said("climb", "down"))) { if (fInBox) {  print("Ok. But animating walking up those stairs was annoying enough.");  clear.lines(23,24,0);  erase(ego);  reset(fInBox);  set.view(ego,0);  set.loop(ego,0);  position(ego,53,146);  draw(ego);  release.loop(ego);  player.control();  } if (fBelowTrap) { print("Ok. But just animating walking up was annoying."); erase(ego); reset(fBelowTrap); position(ego,118,146); draw(ego); } if (!fInBox &&     !fBelowTrap)  {  print("You're not up there.");  }}    if(fSpider) { get.posn(Spider,SpiderX,SpiderY); if (SpiderY==148) { erase(Spider); discard.view(255); reset(fSpider); set(fSpiderDone); goto(done); }} if (Moving) { [stairs in motion get.posn(Stairs,StairX,StairY); if(soundDone) {  if(SqueakDelay > 0) {   SqueakDelay--;   }  else{   sound(3,soundDone);   SqueakDelay = 5;   }  }  if(StairX==5 && PromptStairs) { [under box but not yet set in global flags  StairDir=0;  set.dir(Stairs,StairDir);  egoDir=0;  load.view(0);  erase(ego);  set.view(ego,0);  release.loop(ego);    draw(ego);  discard.view(10);  [force.update(ego);  egoStepTime=1;  step.time(ego,egoStepTime);  reset(PromptStairs); [global flag f21=0  player.control();  StairX=0;  reset(Moving);  goto(done);  } if(StairX==69 && !PromptStairs) { [under trap but not yet set in global flags  StairDir=0;  set.dir(Stairs,StairDir);  egoDir=0;  load.view(0);  erase(ego);  set.view(ego,0);  draw(ego);  discard.view(10);  [force.update(ego);  egoStepTime=1;  step.time(ego,egoStepTime);  set(PromptStairs); [global flag f21 = 1  player.control();  StairX=0;  reset(Moving);   goto(done);  }}   [SPIDER!if ((said("move", "pipe") ||     said("touch", "pipe"))) {  if (posn(ego,141,146,159,154)) {   if (!isset(fSpiderDone)) {    egoDir=0;    load.view(255);    animate.obj(Spider);    set.view(Spider,255);    set.loop(Spider,0);    fix.loop(Spider);    position(Spider,150,10);    draw(Spider);    SpiderDir=5;    set.dir(Spider,SpiderDir);    set(fSpider);    goto(done);    }   else {    print("You've already disturbed poor Insy once. At least give him time to climb up again.");   }   }   else {    print("Whether or not that's a good idea, you can't reach from here.");   } }  [Door to backstageif (said("open", "door")) { if (posn(ego,126,141,137,149)) {  if (Is1881) { [in 1881 door is unlocked  end.of.loop(bsDoor,fBsDoor);  sound(1,soundDone);  } else { [not in 1881  print("The door to this backstage area is securely locked. Perhaps there's another way to reach the other side.");  } } else { [not close enough print("Try moving closer to the door."); }}[MOVE STAIRSif ((said("press", "stairs") ||      said("move", "stairs") ||      said("move", "stairs", "anyword") ||      said("move", "stairs", "anyword", "anyword"))) {  distance(ego,Stairs,StairDistance); if (StairDistance < 8) {  set(Moving); load.view(10); [EgoPush print("You grasp the handle that releases the brake, and put your shoulder to the stand.");   if(!isset(PromptStairs)) { [under box  egoDir=0;  program.control();  erase(ego);  set.view(ego,10);  position(ego,14,148);  draw(ego);  [force.update(ego);  egoStepTime=3;  step.time(ego,egoStepTime);  StairDir=3;  sound(3,soundDone);  SqueakDelay=5;  set.dir(Stairs,StairDir);  egoDir=3;  set(Moving);  goto(done);  }   if(isset(PromptStairs)) { [under trap  egoDir=0;  program.control();  erase(ego);  set.view(ego,10);  position(ego,91,148);  set.loop(ego,1);  draw(ego);    [force.update(ego);  egoStepTime=3;  step.time(ego,egoStepTime);    StairDir=7;  sound(3,soundDone);  SqueakDelay=5;  set.dir(Stairs,StairDir);  egoDir=7;  set(Moving);  goto(done);  } } else { print("The prompter's stand is on casters and easily moved by one strong man (or three weak men), but they have to use their bodies not their minds. Try standing next to it."); }}  [Climbing stairsif ((said("climb", "stairs") ||     said("use", "stairs"))) { if (!PromptStairs) { [stairs under box  if(posn(ego,43,146,51,149)) {   program.control();   egoDir=0;   erase(ego);   erase(Stairs);   set.loop(Stairs,5);   set.cel(Stairs,0);   draw(Stairs);   end.of.loop(Stairs,fClimbing);      goto(done);   }    else {   print(m2);   }  } else { [stairs under trap  if (TrapDoor) { [trap open   if(posn(ego,105,146,115,148)) {    program.control();    egoDir=0;    erase(ego);    position(ego,114,146);    draw(ego);    egoDir=8;    set(fClimbing);    goto(done);    }   else {    print(m2);    }   }   else {    print("The trap door is shut, but maybe there's some way to open it in here.");    } }}       [TRAP LEVERif ((said("pull", "lever") ||     said("push", "lever") ||     said("move", "lever") ||     said("use", "lever"))) { if (posn(ego,128,144,137,150)) {  print("You grasp the lever firmly and give it a tug.");  if(!TrapDoor) { [Door is FALSE, 0, shut    sound(1,soundDone);   erase(Lever);   set.cel(Lever,1); [down, open cel   draw(Lever);   end.of.loop(Trap,fTrapMove);     set(TrapDoor); [Trap door is now TRUE, open   }  else { [Door is TRUE, 1, alreayd open   sound(2,soundDone);   erase(Lever);   set.cel(Lever,0); [up, shut cel   draw(Lever);   reverse.loop(Trap,fTrapMove);   reset(TrapDoor); [Trap door is now FALSE, closed   } } else {  print("Try moving closer to it.");  }}[ place said tests here[[[[staircaseif(said("look","stairs")) { print("These rickety steps, properly called the \"prompter's stand\" allow access to the prompter's box, and also comings and goings through the trap door in the ceiling."); } if(said("look"))    {    print("The \"trap room\" is the area directly beneath the stage. The prompter usually stands on the prompter's stand and sticks his head into the box above. A trap door is used for special effects. Near the other door you notice a lever.");    }if (said("use", "cubbyhole")) { if (fInBox) {  print("We will have a phantomy cutscene here, one time only!");  } else {  print("You have to sit in the prompt box to look through it.");  }}     if (said("look","door")) {  print("One door to the right leads deeper into the backstage heart of the opera house. The other at the far right of the room returns you to the orchestra pit.");  }if (said("look","clutter")) { print("They're the sort of crate found in theatres backstage the world over. Something about the concentration artistic temprement seems to make them spawn spontaneously."); }if (said("open","clutter")) { print("These old boxes have nothing useful inside them. Although if you were a bird you'd probably be interested in sampling the enormous spiders."); } if (said("look", "ceiling")) { print("The ceiling is actually the bottom of the stage floor above. There are two holes cut into it; one for the prompter's box and one for the trap door."); }if (said("look", "cubbyhole")) { print("The prompter sits in the wooden seat suspended beneath his box, during performances. One gains access to the box using the moveable prompter's stand."); }if (said("look", "trap")) { if(!TrapDoor) {  s1 = "closed.";  } else {  s1 = "open.";  }  print("Trap doors in stages are usually for special effects. An actor can enter or exit the stage from the trap by using the prompter's stand. For certain effects, huge mattreses are placed beneath the trap door so that actors can fall through safely. The door is currently %s1"); }if (said("look", "lever")) { if(!TrapDoor) {  s1 = "up,";  } else {  s1 = "down,";  } print("The lever, currently %s1 looks like it performs a mechanical function.");}if (said("look","brick")) { if (Is1881) {  print("In your own time you dimly recall exposed bricks in this room, but here it's as though the Op‚ra has only been open six years.");  } else {  print("In old theatres one naturally finds patches of exposed brick like this.");  }}if (said("look","pipe")) { if (Is1881) {  s1 = "system. It appears to be dripping. Yuck!";  } else {  s1 = "system.";  } print("It's clearly a water pipe, probably connecting all the building's lavatories to the city's famous sewage %s1  ");}if (said("lick", "pipe")) { print("Given what travels through the inside of the pipe, you really don't feel a need to lick it.");}if (said("look", "drip")) { if (Is1881) {  print("The water drips irregularly, as though related to the amount of liquid being forced through it. It might explain why the wall looked so damp in 2021.");  } else {  print("Fortunately, you can't see any drips from the pipe right now.");  }}if ((said("drink", "drip") ||     said("taste", "drip"))) { if (Is1881) {  random(0,2,rndNum);  if (rndNum==0) {   print("The liquid has a pungent, bitterish quality to it.");   }  if (rndNum==1) {   print("You stick out your tongue and are started to receive a sour note from the dripping water.");   }  if (rndNum==2) {   print("Definitely eau de toilette. Hopefully no one saw you do that.");   }  } else {  print("I'm sorry, monsieur, we are currently out of our 1881 vintage eau d'‚gouttement. But maybe zat is for ze best, non?");  }}if (said("smell", "pipe")) { print("Sewage. And it's fresh.");}   :doneif (fDrip) {vDripWait--;}return();   [ **************************************[ MESSAGES[ **************************************#message 1 "You see nothing of interest." #message 2 "It's easier to climb from the foot of the steps."